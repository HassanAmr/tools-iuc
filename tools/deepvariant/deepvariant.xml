<tool id="deepvariant" name="deepvariant" version="0.4.1">
    <description>Call genetic variants from next-generation DNA sequencing data</description>
    <requirements>
        <requirement type="package" version="0.4.1">deepvariant</requirement>
        <requirement type="package" version="1.3.1">samtools</requirement>
    </requirements>
    <command detect_errors="aggressive"><![CDATA[
        mkdir -p logs/ &&
        mkdir -p output.examples.tfrecord/ &&
        ln -s '${reads_input}' temp_reads_input.bam &&
        ln -s '${reads_input.metadata.bam_index}' temp_reads_input.bam.bai &&
        ln -s '${ref_input}' temp_ref_input.fasta &&
        samtools faidx temp_ref_input.fasta &&

        dv_make_examples.py
            --cores \${GALAXY_SLOTS:-2}
            --sample '${sample}'
            --ref temp_ref_input.fasta
            --reads temp_reads_input.bam
            --examples output.examples.tfrecord
            --regions '${regions}'
            --logdir logs
        &&
        dv_call_variants.py
            --cores \${GALAXY_SLOTS:-2}
            --sample '${sample}'
            --outfile call_variants_output.tfrecord
            --examples output.examples.tfrecord
        &&
        dv_postprocess_variants.py
            --ref temp_ref_input.fasta
            --infile call_variants_output.tfrecord
            --outfile '${output}'
]]>
    </command>
    <inputs>
        <param name="reads_input" type="data" format="bam" label="Reads file"
            help="Aligned, sorted, indexed BAM file containing the reads we want to call. Should be aligned to a reference genome compatible with the reference file."/>
        <param name="ref_input" type="data" format="fasta" label="Reference file"
               help="Genome reference to use. Should match the reference used to align the BAM file provided in the reads file."/>
        <param name="sample" type="text" label="Sample"/>
        <param name="regions" type="text" label="Limit to specific regions" help="example: chr20:10,000,000-10,010,000"/>
    </inputs>
    <outputs>
        <data format="vcf" name="output"/>
    </outputs>
    <tests>
        <test>
            <param name="reads_input" value="NA12878_S1.chr20.10_10p1mb.bam" />
            <param name="ref_input" value="ucsc.hg19.chr20.unittest.fasta" />
            <param name="sample" value="xyz" />
            <param name="regions" value="chr20:10,000,000-10,010,000" />
            <output name="output" file="output.vcf" />
        </test>
    </tests>
    <help>
<![CDATA[
    DeepVariant is an analysis pipeline that uses a deep neural network to call genetic
    variants from next-generation DNA sequencing data.</help>
]]>
    <citations>
        <citation type="doi">10.1101/092890</citation>
    </citations>
</tool>
